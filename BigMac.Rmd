---
title: "Big Mac"
output:
  html_document:
    df_print: paged
---

This dataset has been uploaded on Kaggle website. 

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

# Data visualization
```{r}
#dollars_ex is the conversation rate with the local currency. 
#import data
library(dplyr)
bigmac <- read.csv("BigmacPrice.csv", header = TRUE)
#rename columns
names(bigmac)[names(bigmac) == "name"] <- "country"
print(bigmac)
#convert date to date format 
bigmac$date <-as.Date(bigmac$date, format = "%Y-%m-%d")
#average price per country
library(dplyr)
bigmac_grouped <- bigmac %>%
  group_by(country)
bigmac_avg <- bigmac_grouped %>%
  summarise(avg_price = mean(dollar_price))
print(bigmac_avg)
#graph avg
library(ggplot2)
graph_bigmac_avg <- ggplot(bigmac_avg, aes(x=country, y=avg_price)) +
  geom_segment( aes(x=country, xend=country, y=0, yend=avg_price
), color="skyblue") +
  geom_point( color="blue", size=4, alpha=0.6) +
  labs(
  title = "Average price of a bigmac per country since 2000",
  y = "Average price in dollars", x = "Countries"
)+
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank() 
)
graph_bigmac_avg
```
On the blue graph, we see that Norway has the most expensive bigmac in average, and Oman and Kowait the most cheepest ones. 

```{r}
# Average Dollar price bar plot
bigmac %>%
  group_by(country) %>%
  summarize(mean_dollar_price = mean(dollar_price)) %>%
  ggplot(aes(x = reorder(country, mean_dollar_price), y = mean_dollar_price, fill = country)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Average BigMac Dollar Price by Country", x = "Country", y = "Average Dollar Price")
```
On the previous graph, we can see the cheapest to the most expensive bigmac sandwich in dollars. 

For the analysis, we select the few following countries: Norway, Oman, Mexico, Germany and Thailand. 

```{r}
#filter countries
library(ggplot2)
library(dplyr)
bigmac_subset <- bigmac %>% 
  filter(country %in% c("Norway", "Oman", "Thailand", "Mexico", "France"))
bigmac_subset$date <- as.Date(paste0(bigmac_subset$date, "-01-01"))
ggplot(data = bigmac_subset, aes(x = date, y = dollar_price, color = country)) +
  geom_line() +
  labs(title = "BigMac prices through years",
       x = "date",
       y = "dollar_price") +
  scale_color_discrete(name = "country")
#Compute the number of data per country
library(dplyr)
data_country <- bigmac %>% 
  group_by(country) %>% 
  summarise(num_data = n())
  
print(data_country)
```
We see that Oman has only 9 data and Germany only 23. It is a few compared to Norway that has 33 data and Mexico 37. 

```{r}
# Boxplot to see the prices scale per country
ggplot(data = bigmac, aes(x = country, y = dollar_price, fill = country)) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "BigMac Dollar Price Distribution by Country", x = "Country", y = "Dollar Price")
```
On this graph, we can see the scale of the different prices of a Bigmac sandwich per country. We can see that in Venezuela, in Brazil, in Turkey and in Australia, the prices fluctuate a lot. At the opposite, some countries as Taiyan, Switzerland and Honduras have almost the same price for years. We can probably explain this variation with the economical and political situation of the given country. 

```{r}
library(tidyr)
library(viridis)
# Heatmap to see the evolution of dollars price per country
bigmac %>%
  group_by(country, date) %>%
  summarize(mean_dollar_price = mean(dollar_price)) %>%
  spread(date, mean_dollar_price) %>%
  gather(date, mean_dollar_price, -country) %>%
  ggplot(aes(x = date, y = country, fill = mean_dollar_price)) +
  geom_tile() +
  scale_fill_viridis(name = "Dollar Price") +
  theme_minimal() +
  labs(title = "BigMac Dollar Price Heatmap", x = "Date", y = "Country")
```
This heatmap displays the the level of price per country. The lighter color shows the highest prices, and at the opposite, the darker colors represent the lowest prices. The prices change through years. Indeed, we can see that in Brazil, the prices were quite cheap until 2007. Then they started to increase until 2013. And from 2013, the prices decrease again. For a lot of countries we can see that in 2010-2013, the prices increased. 

Ici j'ai rajouté les régions géographiques pour chaques pays pour voir si les groupes sont cohérants
```{r}
#Adding Region to the dataset
country_region <- c("South America", "Oceania", "South America", "Europe", "North America", "South America", "Asia", "Europe", "Europe", "Europe", "Asia", "Europe", "Asia", "Asia", "Asia", "Asia", "North America", "Oceania", "Europe", "Europe", "Asia", "Africa", "Asia", "Europe", "Europe", "Asia", "Asia", "North America", "Asia", "Europe", "South America", "Europe", "South America", "Africa", "South America", "Central America", "Asia", "Asia", "Asia", "Europe", "South America", "Asia", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Asia", "Europe", "Europe", "Europe", "Europe", "Europe", "Europe", "Asia", "Asia", "Asia", "Asia", "Europe", "Central America", "Central America", "Asia", "Asia", "Europe", "Asia", "Europe", "Asia", "Central America", "Asia", "Asia", "Europe", "Europe", "Europe", "Asia")
names(country_region) <- c("Argentina", "Australia", "Brazil", "Britain", "Canada", "Chile", "China", "Czech Republic", "Denmark", "Euro area", "Hong Kong", "Hungary", "Indonesia", "Israel", "Japan", "Malaysia", "Mexico", "New Zealand", "Poland", "Russia", "Singapore", "South Africa", "South Korea", "Sweden", "Switzerland", "Taiwan", "Thailand", "United States", "Philippines", "Norway", "Peru", "Turkey", "Venezuela", "Egypt", "Colombia", "Costa Rica", "Pakistan", "Saudi Arabia", "Sri Lanka", "Ukraine", "Uruguay", "UAE", "Austria", "Belgium", "Estonia", "Finland", "France", "Germany", "Greece", "India", "Ireland", "Italy", "Netherlands", "Portugal", "Spain", "Lithuania", "Vietnam", "Azerbaijan", "Bahrain", "Croatia", "Guatemala", "Honduras", "Jordan", "Kuwait", "Latvia", "Lebanon", "Moldova", "Nicaragua", "Oman", "Qatar", "Romania", "Slovakia", "Slovenia", "United Arab Emirates")
#New dataset of bigmax with regions
bigmac_region <- bigmac %>% mutate(Region = country_region[country])
#Boxplot analysis
ggplot(bigmac_region, aes(x = Region, y = dollar_price)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Big Mac Index Distribution by Region", x = "Region", y = "Big Mac Index")
bigmac_region_date <- bigmac_region %>% mutate(Date = as.Date(date, format = "%Y-%m-%d"))
#Regional Big Mac Index trends
ggplot(bigmac_region, aes(x = date, y = dollar_price, color = Region)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Big Mac Index Time Series by Region", x = "Date", y = "Big Mac Index") +
  theme(legend.title = element_blank()) +
  facet_wrap(~ Region, scales = "free_y", nrow = 2)
ggplot(bigmac_region, aes(x = date, y = dollar_price, color = Region)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Big Mac Index Time Series by Region", x = "Date", y = "Big Mac Index") +
  theme(legend.title = element_blank())
```

```{r}
bigmac_region_avg <- bigmac_region %>%
  group_by(Region, year = format(date, "%Y")) %>%
  summarize(avg_dollar_price = mean(dollar_price), .groups = "drop")
ggplot(bigmac_region, aes(x = date, y = dollar_price, color = Region)) +
  geom_point(alpha = 0.5) +
  geom_line(data = bigmac_region_avg, aes(x = as.Date(paste(year, "-01-01", sep = ""), format = "%Y-%m-%d"), y = avg_dollar_price), size = 1.5) +
  theme_minimal() +
  labs(title = "Big Mac Index Time Series by Region", x = "Date", y = "Big Mac Index") +
  theme(legend.title = element_blank())
```

From this graph, we see different prices behavior depending of the regions. First, we clearly identify that South America has a lot of prices fluctuation compared to other regions; especially a big decrease between 2013-2015. The other regions are more calm in terms of fluctuation. We especially observe a long and regular increase of prices in Oceania and North America. 


```{r}
#import data inflation to do the correlation between the two datasets 
library(readxl)
library(tidyverse)
library(janitor)
inflation_data <- read_excel("imf-dm-export-20230419.xls")
```

```{r}
inflation_data_clean <- inflation_data %>%
  # Remove first row (full of NA)
  slice(-1) %>%
  # Rename first column to "Country"
  rename(Country = `Inflation rate, average consumer prices (Annual percent change)`) %>%
  # Remove "no data" values and convert to NA
  mutate_all(funs(na_if(., "no data"))) %>%
  # Convert all values to numeric, except "Country"
  mutate_at(vars(-Country), as.numeric) %>%
  # Round all numeric values to 2 decimal, except "Country"
  mutate_at(vars(-Country), round, 2) %>%
  # Wide format to long format
  gather(key = "Year", value = "Inflation_Rate", -Country) %>%
  # Convert "Year" column to integer data type
  mutate(Year = as.integer(Year))
```

```{r}
# Remove NA 
inf <- na.omit(inflation_data_clean)
# Only keep years from 2000 to 2022
inf_filtered <- inf %>% filter(Year >= 2000 & Year <= 2022)
# to only have the years 
bigmac$Year <- format(as.Date(bigmac$date), "%Y")
#Remove unnecessary collumns 
bigmacc <- bigmac[, c(-1, -2, -4, -5)]
#Rename column
bigmacc <- bigmacc %>%
    rename(Country = country)
#column year in integer
bigmacc$Year <- as.integer(bigmacc$Year)
# the average dollar price of the Big Mac for each country and year
bigmacc <- bigmacc %>%
 group_by(Country, Year) %>%
     summarise(avg_dollar_price = mean(dollar_price, na.rm = TRUE))
#Merge the data per year and for the 4 countries

inf_filtered[inf_filtered == "Taiwan Province of China"] <- 'Taiwan'
countries <- c("Taiwan", "Switzerland", "Brazil", "Venezuela")
merged_data <- inner_join(inf_filtered %>% filter(Country %in% countries),
                          bigmacc %>% filter(Country %in% countries),
                          by = c("Country", "Year"))

# Compute correlations by country
by_country <- merged_data %>% 
    group_by(Country)

corr_by_country <- merged_data %>%
     group_by(Country) %>%
     summarise(cor = cor(Inflation_Rate, avg_dollar_price, use = "pairwise.complete.obs"),
               p_value = cor.test(Inflation_Rate, avg_dollar_price, use = "pairwise.complete.obs")$p.value)
```

```{r}
print(corr_by_country)
```


# Focus on selected countries

## Visualization

```{r}
# Filter data for the specified countries
selected_countries <- c("Venezuela", "Brazil", "Switzerland", "Taiwan")
bigmac_filtered <- bigmac %>%
  filter(country %in% selected_countries)
bigmac_grouped2 <- bigmac_filtered %>%
  group_by(country)
bigmac_avg2 <- bigmac_grouped2 %>%
  summarise(avg_price = mean(dollar_price))
print(bigmac_avg2)
#graph avg
library(ggplot2)
graph_bigmac_avg2 <- ggplot(bigmac_avg2, aes(x=country, y=avg_price)) +
  geom_segment( aes(x=country, xend=country, y=0, yend=avg_price
), color="darkorange") +
  geom_point( color="coral", size=4, alpha=0.6) +
  labs(
  title = "Average price of a bigmac per country since 2000",
  y = "Average price in dollars", x = "Countries"
)+
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank() 
)
graph_bigmac_avg2
```

```{r}
# Average Dollar price bar plot
bigmac %>%
  filter(country %in% selected_countries) %>%
  group_by(country) %>%
  summarize(mean_dollar_price = mean(dollar_price)) %>%
  ggplot(aes(x = reorder(country, mean_dollar_price), y = mean_dollar_price, fill = country)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Average BigMac Dollar Price by Selected Countries", x = "Country", y = "Average Dollar Price")
```

```{r}
# Box plot for the 4 selected countries
bigmac %>%
  filter(country %in% selected_countries) %>%
  ggplot(aes(x = country, y = dollar_price, fill = country)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "BigMac Dollar Price Distribution for Selected Countries", x = "Country", y = "Dollar Price")
```

```{r}
bigmac %>%
  filter(country %in% selected_countries) %>%
  group_by(country, date) %>%
  summarize(mean_dollar_price = mean(dollar_price)) %>%
  spread(date, mean_dollar_price) %>%
  gather(date, mean_dollar_price, -country) %>%
  ggplot(aes(x = date, y = country, fill = mean_dollar_price)) +
  geom_tile() +
  scale_fill_viridis(name = "Dollar Price") +
  theme_minimal() +
  labs(title = "BigMac Dollar Price Heatmap for Selected Countries", x = "Date", y = "Country")
```
## Models

Let's prepare our data : 

```{r}
library(dplyr)
library(tidyr)
library(forecast)
library(ggplot2)
library(zoo)
library(xts)
# Filter the data for the 4 selected countries
filtered_bigmac <- bigmac %>%
  filter(country %in% selected_countries)
# Pivot the data to a wide format
wide_bigmac <- filtered_bigmac %>%
  select(country, date, dollar_price) %>%
  spread(country, dollar_price) %>%
  arrange(date)

wide_bigmac_yearly <- wide_bigmac %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarise(across(starts_with(selected_countries), mean, na.rm = TRUE))


# Create a time series object for each country
# time_series_list <- lapply(wide_bigmac_yearly[-1], ts, start = min(wide_bigmac_yearly$year), frequency = 1)
# time_series_list <- lapply(wide_bigmac[-1], ts, start = c(year(min(wide_bigmac$date))), frequency = 12)

#time_series_list <- lapply(wide_bigmac[-1], ts, start = c(year(min(wide_bigmac$date)), month(min(wide_bigmac$date)), frequency = 12))

# Create a list of zoo objects, works but 
#time_series_list <- lapply(wide_bigmac[-1], function(x) {
#  zoo(x, order.by = wide_bigmac$date)
#})

#This works but wrong dates
time_series_list <- lapply(wide_bigmac_yearly[-1], ts, start = c(year(min(wide_bigmac$date))), frequency = 1)
```

We are vizualizing our time series for the 4 countries : 

```{r}
# Plot the time series
for (i in seq_along(selected_countries)) {
  ts_plot <- ggplot(data = wide_bigmac, aes(x = date, y = wide_bigmac[[i + 1]])) +
    geom_line() +
    labs(title = paste("Time Series of", selected_countries[i]), x = "Year", y = "Dollar Price") +
    theme_minimal()
  print(ts_plot)
}
```
We observe that Taiwan has many missing values so we will do an interpolation to counter that. 

```{r}
#Here we do an interpolation in order to fill the NA's
time_series_list <- lapply(time_series_list, function(x) na.approx(x, rule = 2))

```

First of all lets perform easy models. Here we will start with a Simple Exponential Smoothing since we have no seasonality and no clear trend in our data. 

```{r}
# Fit Simple Exponential Smoothing (SES) models
ses_models <- lapply(time_series_list, ses)

# Forecast using SES models
ses_forecasts <- lapply(ses_models, forecast, h = 5)

# Plot forecasts
for (i in seq_along(selected_countries)) {
  plot(ses_forecasts[[i]], main = paste("SES Forecast for", selected_countries[i]), xlab = "Year", ylab = "Dollar Price")
}

library(zoo)
library(ggplot2)

yearly_forecasts <- lapply(ses_forecasts, function(x) {
  forecast_data <- data.frame(Date = time(x$mean), Forecast = x$mean)
  forecast_data$Year <- format(as.Date(as.yearmon(forecast_data$Date)), "%Y")
  yearly_forecast <- forecast_data %>%
    group_by(Year) %>%
    summarise(Avg_Forecast = mean(Forecast))
  return(yearly_forecast)
})

```
We are now performing a Holt's Linear model with only trend but no seasonality. 

```{r}
# Fit Holt's Linear Trend models
holt_models <- lapply(time_series_list, holt)

# Forecast using Holt's Linear Trend models
holt_forecasts <- lapply(holt_models, forecast, h = 10)

# Plot forecasts
for (i in seq_along(selected_countries)) {
  plot(holt_forecasts[[i]], main = paste("Holt's Linear Trend Forecast for", selected_countries[i]), xlab = "Year", ylab = "Dollar Price")
}
```
Here we are looking into an ETS model 
```{r}
# Fit ETS models
ets_models <- lapply(time_series_list, ets)
# Forecast using ETS models
ets_forecasts <- lapply(ets_models, forecast, h = 5)
# Plot forecasts
for (i in seq_along(selected_countries)) {
  plot(ets_forecasts[[i]], main = paste("ETS Forecast for", selected_countries[i]), xlab = "Year", ylab = "Dollar Price")
}
```
We are here perfroming a STL decomposition. Since we have NA's values in our Taiwan dataset, we are currently doing an interpolation for the missing values then we perform our model. 
```{r}
stl_models <- lapply(time_series_list, stl, s.window = "periodic")

for (i in seq_along(selected_countries)) {
  plot(stl_models[[i]], main = paste("STL Decomposition for", selected_countries[i]))
}
```
Now we are perfomring an ARIMA model for our 4 countries : 
```{r}
# Fit ARIMA models and forecast
arima_models <- lapply(time_series_list, auto.arima)
arima_forecasts <- lapply(arima_models, forecast, h = 5)

# Plot ARIMA forecasts
for (i in seq_along(selected_countries)) {
  plot(arima_forecasts[[i]], main = paste("ARIMA Forecast for", selected_countries[i]), xlab = "Year", ylab = "Dollar Price")
}
```
Here, we perform a STLF (Seasonal Decomposition of Time Series + ARIMA forecasting) for our 4 countries. 
```{r}
library(forecast)
library(stats)

# Fit STLF models and forecast
stlf_models <- lapply(time_series_list, stlf)
stlf_forecasts <- lapply(stlf_models, forecast, h = 12 )

# Calculate and display AIC and BIC for each model
aic_values <- lapply(stlf_models, function(model) AIC(model$model))
bic_values <- lapply(stlf_models, function(model) BIC(model$model))

# Print AIC and BIC values
print(aic_values)
print(bic_values)
print(paste("AIC values: ", aic_values))
print(paste("BIC values: ", bic_values))

# Plot STLF forecasts
for (i in seq_along(selected_countries)) {
  plot(stlf_forecasts[[i]], main = paste("STLF Forecast for", selected_countries[i]), xlab = "Year", ylab = "Dollar Price")
}
```

Let's introduce the covariates. As discussed with the assistant, we only need 1 covariate so let's introduce the Annual GDP Growth Rate of Output per Worker.

```{r}

# Import the data
gdpgrowth <- read_csv("gdpgrowth.csv")
gdpgrowth$ref_area.label[gdpgrowth$ref_area.label == "Taiwan, China"] <- "Taiwan"
gdpgrowth$ref_area.label[gdpgrowth$ref_area.label == "Venezuela, Bolivarian Republic of"] <- "Venezuela"

# Filter the data for the selected countries
filtered_gdpgrowth <- gdpgrowth %>%
  filter(ref_area.label %in% selected_countries)

# Initialize a list to hold dataframes for each country
country_dfs <- list()

# Continue with the existing code
for (country in selected_countries) {
  # Filter for the specific country
  country_df <- filtered_gdpgrowth %>%
    filter(ref_area.label == country) %>%
    select(year = time, GDP_growth = obs_value)
  
  # Add to the list
  country_dfs[[country]] <- country_df
}
```

```{r}
# Join the data with the existing time series

for (i in seq_along(selected_countries)) {
  # Capitalize the 'year' column in the dataframe
  names(country_dfs[[selected_countries[i]]])[names(country_dfs[[selected_countries[i]]]) == "year"] <- "Year"
  
  time_series_df <- data.frame(
    Year = floor(time(time_series_list[[i]])), # Get the year part of the time series index
    Dollar_Price = as.numeric(time_series_list[[i]]) # Convert time series data to numeric
  )
  
  # Merge the two dataframes
  merged_df <- merge(time_series_df, country_dfs[[selected_countries[i]]], by = "Year", all.x = TRUE)
  
  # Handle any missing values after the merge
  merged_df$GDP_growth[is.na(merged_df$GDP_growth)] <- 0 # Or use any other imputation method
  
  # Replace the time series with the merged dataframe
  time_series_list[[i]] <- ts(merged_df$Dollar_Price, start = c(min(merged_df$Year), 1), frequency = 12)
  
  # Replace the GDP growth rate with the merged dataframe
  country_dfs[[selected_countries[i]]] <- merged_df$GDP_growth
}

```

```{r}
# Redefine the models with the new time series
arima_models_cov <- mapply(function(ts, covariate) {
  auto.arima(ts, xreg = as.matrix(covariate))
}, ts = time_series_list, covariate = country_dfs, SIMPLIFY = FALSE)

# Get the AIC for the models with the covariates
aic_values_cov <- lapply(arima_models_cov, AIC)

# Compare the AIC values for the models with and without the covariates
aic_comparison <- data.frame(
  Country = selected_countries,
  AIC_Without_Covariates = unlist(aic_values),
  AIC_With_Covariates = unlist(aic_values_cov)
)

# Print the AIC comparison
print(aic_comparison)

```

```{r}
# Plot the actual vs predicted prices for the test / training set
for (i in seq_along(selected_countries)) {
  fitted_values <- fitted(arima_models_cov[[i]])
  actual_values <- time_series_list[[i]]
  
  df <- data.frame(
    Year = time(fitted_values),
    Actual_Price = actual_values,
    Predicted_Price = fitted_values
  )
  
  plot <- ggplot(df, aes(x = Year)) +
    geom_line(aes(y = Actual_Price), color = "blue") +
    geom_line(aes(y = Predicted_Price), color = "red") +
    labs(
      title = paste("Actual vs Predicted Prices for", selected_countries[i]),
      x = "Year",
      y = "Dollar Price"
    ) +
    theme_minimal()
  print(plot)
}
```

```{r}
# Plot the actual vs predicted prices for the models with and without covariates
for (i in seq_along(selected_countries)) {
  fitted_values_cov <- fitted(arima_models_cov[[i]])
  fitted_values_without_cov <- fitted(arima_models[[i]])
  actual_values <- time_series_list[[i]]
  
  df <- data.frame(
    Year = time(fitted_values_cov),
    Actual_Price = actual_values,
    Predicted_Price_with_Cov = fitted_values_cov,
    Predicted_Price_without_Cov = fitted_values_without_cov
  )
  
  plot <- ggplot(df, aes(x = Year)) +
    geom_line(aes(y = Actual_Price, color = "Actual Price")) +
    geom_line(aes(y = Predicted_Price_with_Cov, color = "Predicted with Covariates")) +
    geom_line(aes(y = Predicted_Price_without_Cov, color = "Predicted without Covariates")) +
    labs(
      title = paste("Actual vs Predicted Prices for", selected_countries[i]),
      x = "Year",
      y = "Dollar Price",
      color = "Legend"
    ) +
    scale_color_manual(values = c("Actual Price" = "blue", 
                                  "Predicted with Covariates" = "red", 
                                  "Predicted without Covariates" = "green")) +
    theme_minimal() +
    theme(legend.position = "bottom")
  print(plot)
}

```