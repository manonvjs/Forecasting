---
title: "Swiss electricty exports"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

First of all let us import the data : 
```{r}
#import data
library(readxl)
library(feasts)
library(forecast)
library(tsibble)
library(feasts)
library(ggplot2)
library(zoo)
Electricityraw <- read_excel("Electricity export Switzerland-3.xlsx")
```
## 1 Data and Wrangling 
Here, we are going to do some basic modification of the raw data in order to be a bit more readable
```{r}
# Rename the columns
colnames(Electricityraw) <- c("Date", "Germany", "France", "Austria", "Liechtenstein", "Italy", "Total.Export")
# Remove the first 4 rows
Electricity <- Electricityraw[-c(1:4), ]
# Change Oktober for October
Electricity$Date <- gsub("Oktober", "October", Electricity$Date)
# Convert the date column to a date object
Electricity$Date <- as.Date(paste0("01 ", Electricity$Date), format = "%d %B %Y")
```

Our column are in a character form, we want to transfrom them in a numeric format since they represent continuous values. 
```{r}
# Convert the electricity export columns to numeric
Electricity$Germany <- as.numeric(Electricity$Germany)
Electricity$France <- as.numeric(Electricity$France)
Electricity$Austria <- as.numeric(Electricity$Austria)
Electricity$Liechtenstein <- as.numeric(Electricity$Liechtenstein)
Electricity$Italy <- as.numeric(Electricity$Italy)
Electricity$Total.Export <- as.numeric(Electricity$Total.Export)
```


Lets check if there are some missing values in our dataset 
```{r}
# Check if there are any missing values in the dataset
missing_values <- is.na(Electricity)

# Check if any columns contain missing values
missing_values_per_column <- colSums(missing_values)
print(missing_values_per_column)
```
So apparently, there are are no missing values in our data. 

```{r eval=FALSE}
# Function to identify and treat outliers using the IQR method
treat_outliers_iqr <- function(data, k = 1.5) {
  Q1 <- quantile(data, 0.25)
  Q3 <- quantile(data, 0.75)
  IQR <- Q3 - Q1
  lower_bound <- Q1 - k * IQR
  upper_bound <- Q3 + k * IQR

  # Replace outliers with NA
  data[data < lower_bound | data > upper_bound] <- NA
  return(data)
}

# Apply the function to each country's time series
Electricity$Germany <- treat_outliers_iqr(Electricity$Germany)
Electricity$France <- treat_outliers_iqr(Electricity$France)
Electricity$Austria <- treat_outliers_iqr(Electricity$Austria)
Electricity$Liechtenstein <- treat_outliers_iqr(Electricity$Liechtenstein)
Electricity$Italy <- treat_outliers_iqr(Electricity$Italy)
Electricity$Total.Export <- treat_outliers_iqr(Electricity$Total.Export)


```

## 2.0 Vizualisation 

### 2.1 Time series 
```{r}
# Create a time series object for the Total.Export data
ts_data <- ts(Electricity$Total.Export, start = c(2000, 1), frequency = 12)
# Create a time series object for the Germany data
ts_germany <- ts(Electricity$Germany, start = c(2000, 1), frequency = 12)
# Create a time series object for the France data
ts_france <- ts(Electricity$France, start = c(2000, 1), frequency = 12)
# Create a time series object for the Italy data
ts_italy <- ts(Electricity$Italy, start = c(2000, 1), frequency = 12)
# Create a time series object for the Austria data
ts_austria <- ts(Electricity$Austria, start = c(2000, 1), frequency = 12)
# Create a time series object for the Liechtenstein data
ts_liechtenstein <- ts(Electricity$Liechtenstein, start = c(2000, 1), frequency = 12)
# Plot the Total.Export time series
plot(ts_data, xlab = "Year", ylab = "Electricity export (GWh)", main = "Electricity Export - Total")
# Plot the Germany time series
plot(ts_germany, xlab = "Year", ylab = "Electricity export (GWh)", main = "Electricity Export - Germany")
# Plot the France time series
plot(ts_france, xlab = "Year", ylab = "Electricity export (GWh)", main = "Electricity Export - France")
# Plot the Italy time series
plot(ts_italy, xlab = "Year", ylab = "Electricity export (GWh)", main = "Electricity Export - Italy")
# Plot the Austria time series
plot(ts_austria, xlab = "Year", ylab = "Electricity export (GWh)", main = "Electricity Export - Austria")
# Plot the Liechtenstein time series
plot(ts_liechtenstein, xlab = "Year", ylab = "Electricity export (GWh)", main = "Electricity Export - Liechtenstein")
```
At first glance, we can guess that there is seasonality for each country. If we focus ourselves on stationary of the data, we can easily say that Italie and Lichtnestein are stationary. There is a huge drop in 2009 for the electricity export in Italie. For the Lichtenstein, we observe a a low increase from 2017 to 2020 followed by a small drop. 



### 2.1 STL Decomposition 
```{r}
# Define the countries vector
countries <- c("Germany", "France", "Austria", "Liechtenstein", "Italy", "Total.Export")

# Function to create and plot seasonal decomposition for a given country
plot_stl_decomposition <- function(data, country) {
  # Create a time series object
  country_ts <- ts(data[[country]], start = c(2000, 1), frequency = 12)
  
  # Perform STL decomposition
  country_stl <- stl(country_ts, s.window = "periodic")
  
  # Plot the seasonal decomposition
  plot(country_stl, main = paste("STL Decomposition for", country))
}

# Use the function to create and display STL decomposition plots for each country
for (country in countries) {
  plot_stl_decomposition(Electricity, country)
}

```
Italie : Clear seasonality with raises in Winter and drops in Summer. As for the trend, from 2000 to 2008, we observe a small incrase followed by huge drop until 2010. Since 2010, the trend is constant. 

Lichtenstein : Clear sesonality with drops every beggning of the years while raising for the Summer. The trend shows constant value until 2017 where there is a huge raise until 2020. This raise is followed by a drop until 2021 and then a small increase.

```{r}
# Function to create and display the seasonal subseries plot for a given country
plot_seasonal_subseries <- function(data, country) {
  # Create a time series object
  country_ts <- ts(data[[country]], start = c(2000, 1), frequency = 12)
  
  # Create a seasonal subseries plot
  seasonal_subseries_plot <- ggseasonplot(country_ts, year.labels = TRUE, year.labels.left = TRUE,
                                          main = paste("Seasonal Subseries Plot for", country),
                                          xlab = "Month", ylab = "Electricity Export (GWh)")

  # Display the plot
  print(seasonal_subseries_plot)
}

# Use the function to create and display seasonal subseries plots for each country
for (country in countries) {
  plot_seasonal_subseries(Electricity, country)
}
```

```{r}
# Convert the time series objects to tsibble objects
ts_data_tsibble <- ts_data %>% as_tsibble(index = index(ts_data))
ts_germany_tsibble <- ts_germany %>% as_tsibble(index = index(ts_germany))
ts_france_tsibble <- ts_france %>% as_tsibble(index = index(ts_france))
ts_italy_tsibble <- ts_italy %>% as_tsibble(index = index(ts_italy))
ts_austria_tsibble <- ts_austria %>% as_tsibble(index = index(ts_austria))
ts_liechtenstein_tsibble <- ts_liechtenstein %>% as_tsibble(index = index(ts_liechtenstein))

# Create seasonal subseries plots for each country using tsibble objects
germany_plot <- gg_subseries(ts_germany_tsibble) +
  labs(title = "Seasonal Subseries Plot for Germany", x = "Month", y = "Electricity Export (GWh)")

france_plot <- gg_subseries(ts_france_tsibble) +
  labs(title = "Seasonal Subseries Plot for France", x = "Month", y = "Electricity Export (GWh)")

austria_plot <- gg_subseries(ts_austria_tsibble) +
  labs(title = "Seasonal Subseries Plot for Austria", x = "Month", y = "Electricity Export (GWh)")

liechtenstein_plot <- gg_subseries(ts_liechtenstein_tsibble) +
  labs(title = "Seasonal Subseries Plot for Liechtenstein", x = "Month", y = "Electricity Export (GWh)")

italy_plot <- gg_subseries(ts_italy_tsibble) +
  labs(title = "Seasonal Subseries Plot for Italy", x = "Month", y = "Electricity Export (GWh)")

total_export_plot <- gg_subseries(ts_data_tsibble) +
  labs(title = "Seasonal Subseries Plot for Total.Export", x = "Month", y = "Electricity Export (GWh)")


# Display the plots
print(germany_plot)
print(france_plot)
print(austria_plot)
print(liechtenstein_plot)
print(italy_plot)
print(total_export_plot)
```

```{r}
# Function to create ACF plot for a given time series
plot_acf <- function(ts_data, country) {
  acf_data <- acf(ts_data, plot = FALSE)
  acf_df <- data.frame(Lag = 1:length(acf_data$acf), ACF = acf_data$acf)
  ggplot(acf_df, aes(x = Lag, y = ACF)) + geom_bar(stat = "identity") +
    labs(title = paste("ACF plot for", country), x = "Lag", y = "Autocorrelation") +
    theme_minimal()
}


# Create and display ACF plots for each country
plot_acf(ts_data, "Total.Export")
plot_acf(ts_germany, "Germany")
plot_acf(ts_france, "France")
plot_acf(ts_italy, "Italy")
plot_acf(ts_austria, "Austria")
plot_acf(ts_liechtenstein, "Liechtenstein")
```

## 3.0 Cleaning and wrankling

## 4.0 Modeling 

### ETS model

```{r}
# Impute missing values using linear interpolation
Electricity$Germany <- na.approx(Electricity$Germany)
Electricity$France <- na.approx(Electricity$France)
Electricity$Austria <- na.approx(Electricity$Austria)
Electricity$Liechtenstein <- na.approx(Electricity$Liechtenstein)
Electricity$Italy <- na.approx(Electricity$Italy)
Electricity$Total.Export <- na.approx(Electricity$Total.Export)

# Create time series objects
ts_germany <- ts(Electricity$Germany, frequency = 12, start = c(2000, 1))
ts_france <- ts(Electricity$France, frequency = 12, start = c(2000, 1))
ts_austria <- ts(Electricity$Austria, frequency = 12, start = c(2000, 1))
ts_liechtenstein <- ts(Electricity$Liechtenstein, frequency = 12, start = c(2000, 1))
ts_italy <- ts(Electricity$Italy, frequency = 12, start = c(2000, 1))
ts_total_export <- ts(Electricity$Total.Export, frequency = 12, start = c(2000, 1))

# Apply ETS model
ets_germany <- ets(ts_germany)
ets_france <- ets(ts_france)
ets_austria <- ets(ts_austria)
ets_liechtenstein <- ets(ts_liechtenstein)
ets_italy <- ets(ts_italy)
ets_total_export <- ets(ts_total_export)
```

```{r}
# Forecast
n_forecast <- 12  # Number of periods to forecast
forecast_germany <- forecast(ets_germany, h = n_forecast)
forecast_france <- forecast(ets_france, h = n_forecast)
forecast_austria <- forecast(ets_austria, h = n_forecast)
forecast_liechtenstein <- forecast(ets_liechtenstein, h = n_forecast)
forecast_italy <- forecast(ets_italy, h = n_forecast)
forecast_total_export <- forecast(ets_total_export, h = n_forecast)
```

```{r}
# Extract data from the forecast object
forecast_data_germany <- data.frame(
  Date = seq(min(Electricity$Date), by = "month", length.out = length(ts_germany) + n_forecast),
  Value = c(ts_germany, as.numeric(forecast_germany$mean)),
  Type = c(rep("Observed", length(ts_germany)), rep("Forecast", n_forecast))
)

# Plot forecasts
ggplot(data = forecast_data_germany, aes(x = Date, y = Value, color = Type)) +
  geom_line() +
  ggtitle("Electricity Export Forecast for Germany") +
  xlab("Year") + ylab("Export Volume")

```

```{r}
# Extract data from the forecast object
forecast_data_france <- data.frame(
  Date = seq(min(Electricity$Date), by = "month", length.out = length(ts_france) + n_forecast),
  Value = c(ts_france, as.numeric(forecast_france$mean)),
  Type = c(rep("Observed", length(ts_france)), rep("Forecast", n_forecast))
)

# Plot forecasts
ggplot(data = forecast_data_france, aes(x = Date, y = Value, color = Type)) +
  geom_line() +
  ggtitle("Electricity Export Forecast for France") +
  xlab("Year") + ylab("Export Volume")
```

```{r}
# Extract data from the forecast object
forecast_data_austria <- data.frame(
  Date = seq(min(Electricity$Date), by = "month", length.out = length(ts_austria) + n_forecast),
  Value = c(ts_austria, as.numeric(forecast_austria$mean)),
  Type = c(rep("Observed", length(ts_austria)), rep("Forecast", n_forecast))
)

# Plot forecasts
ggplot(data = forecast_data_austria, aes(x = Date, y = Value, color = Type)) +
  geom_line() +
  ggtitle("Electricity Export Forecast for Austria") +
  xlab("Year") + ylab("Export Volume")
```

```{r}
# Extract data from the forecast object
forecast_data_liechtenstein <- data.frame(
  Date = seq(min(Electricity$Date), by = "month", length.out = length(ts_liechtenstein) + n_forecast),
  Value = c(ts_liechtenstein, as.numeric(forecast_liechtenstein$mean)),
  Type = c(rep("Observed", length(ts_liechtenstein)), rep("Forecast", n_forecast))
)

# Plot forecasts
ggplot(data = forecast_data_liechtenstein, aes(x = Date, y = Value, color = Type)) +
  geom_line() +
  ggtitle("Electricity Export Forecast for Liechtenstein") +
  xlab("Year") + ylab("Export Volume")
```

```{r}
# Extract data from the forecast object
forecast_data_italy <- data.frame(
  Date = seq(min(Electricity$Date), by = "month", length.out = length(ts_italy) + n_forecast),
  Value = c(ts_italy, as.numeric(forecast_italy$mean)),
  Type = c(rep("Observed", length(ts_italy)), rep("Forecast", n_forecast))
)

# Plot forecasts
ggplot(data = forecast_data_italy, aes(x = Date, y = Value, color = Type)) +
  geom_line() +
  ggtitle("Electricity Export Forecast for Italy") +
  xlab("Year") + ylab("Export Volume")
```

```{r}
# Extract data from the forecast object
forecast_data_total_export <- data.frame(
  Date = seq(min(Electricity$Date), by = "month", length.out = length(ts_total_export) + n_forecast),
  Value = c(ts_total_export, as.numeric(forecast_total_export$mean)),
  Type = c(rep("Observed", length(ts_total_export)), rep("Forecast", n_forecast))
)

# Plot forecasts
ggplot(data = forecast_data_total_export, aes(x = Date, y = Value, color = Type)) +
  geom_line() +
  ggtitle("Electricity Export Forecast for all the countries") +
  xlab("Year") + ylab("Export Volume")
```

